<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Preventivas</title>
  <style>
    :root {
      --azul: #0e7ad3;
      --cinza: #f4f6f9;
      --borda: #e3e8ef;
      --texto: #0f172a;
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--cinza);
      color: var(--texto);
      margin: 0; padding: 20px;
    }
    h1 { text-align: center; margin: 0 0 10px; }
    .sub { text-align: center; color: #475569; margin-bottom: 18px; }

    .toolbar {
      max-width: 1000px; margin: 0 auto 16px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; justify-content: center;
    }
    .toolbar input[type="text"] { flex: 1; min-width: 280px; padding: 8px 10px; border: 1px solid var(--borda); border-radius: 10px; }
    .btn { padding: 8px 12px; border: 1px solid var(--borda); border-radius: 10px; background: white; cursor: pointer; }
    .btn:active { transform: translateY(1px); }
    .status { font-size: 14px; color: #334155; }

    .grupo { background: white; margin: 10px auto; border-radius: 12px; box-shadow: 0 4px 10px rgba(2,6,23,.06); overflow: hidden; max-width: 1000px; border: 1px solid var(--borda); }
    .grupo-header { padding: 14px 16px; background: var(--azul); color: white; cursor: pointer; font-weight: 600; display:flex; justify-content:space-between; align-items:center; }
    .grupo-header small { opacity: .9; font-weight: 500; }
    .grupo-conteudo { display: none; padding: 16px; }

    .preventiva { display: grid; grid-template-columns: 28px 1fr 1.2fr; gap: 10px; align-items: center; padding: 8px 0; border-bottom: 1px dashed var(--borda); }
    .preventiva:last-child { border-bottom: 0; }
    .nome { font-weight: 600; }
    .preventiva input[type="checkbox"] { width: 18px; height: 18px; }
    .preventiva input[type="text"] { padding: 8px 10px; border: 1px solid var(--borda); border-radius: 10px; }

    .area-notas { margin-top: 12px; }
    textarea { width: 100%; min-height: 70px; padding: 10px 12px; border-radius: 12px; border: 1px solid var(--borda); resize: vertical; }

    .rodape { max-width: 1000px; margin: 14px auto 0; color: #475569; font-size: 13px; text-align:center; }
  </style>
</head>
<body>
  <h1>Checklist de Preventivas</h1>
  <div class="sub">6 grupos ‚Ä¢ 11 preventivas por grupo ‚Ä¢ Salva local e sincroniza com Google Sheets</div>

  <div class="toolbar">
    <input id="webappUrl" type="text" placeholder="Cole aqui a URL do Web App do Google Apps Script (termina com /exec)" />
    <button class="btn" id="btnSalvarUrl">Usar esta URL</button>
    <button class="btn" id="btnSync">For√ßar sincroniza√ß√£o</button>
    <span class="status" id="syncStatus">Sem sincroniza√ß√£o ainda</span>
  </div>

  <div id="grupos"></div>
  <div class="rodape">Dica: clique no cabe√ßalho do grupo para expandir/fechar. Mudan√ßas salvam automaticamente.</div>

  <script>
    // =========================
    // CONFIGURA√á√ÉO DOS NOMES
    // Preencha aqui os nomes pr√©-definidos das preventivas por grupo (opcional).
    // Se n√£o preencher, ser√° usado "Preventiva X" por padr√£o.
    const NOMES = {
      1: ["Preventiva 1","Preventiva 2","Preventiva 3","Preventiva 4","Preventiva 5","Preventiva 6","Preventiva 7","Preventiva 8","Preventiva 9","Preventiva 10","Preventiva 11"],
      2: ["Preventiva 1","Preventiva 2","Preventiva 3","Preventiva 4","Preventiva 5","Preventiva 6","Preventiva 7","Preventiva 8","Preventiva 9","Preventiva 10","Preventiva 11"],
      3: ["Preventiva 1","Preventiva 2","Preventiva 3","Preventiva 4","Preventiva 5","Preventiva 6","Preventiva 7","Preventiva 8","Preventiva 9","Preventiva 10","Preventiva 11"],
      4: ["Preventiva 1","Preventiva 2","Preventiva 3","Preventiva 4","Preventiva 5","Preventiva 6","Preventiva 7","Preventiva 8","Preventiva 9","Preventiva 10","Preventiva 11"],
      5: ["Preventiva 1","Preventiva 2","Preventiva 3","Preventiva 4","Preventiva 5","Preventiva 6","Preventiva 7","Preventiva 8","Preventiva 9","Preventiva 10","Preventiva 11"],
      6: ["Preventiva 1","Preventiva 2","Preventiva 3","Preventiva 4","Preventiva 5","Preventiva 6","Preventiva 7","Preventiva 8","Preventiva 9","Preventiva 10","Preventiva 11"],
    };

    // =========================
    // ESTADO & UTILIT√ÅRIOS
    const $ = (sel, ctx=document) => ctx.querySelector(sel);
    const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
    const statusEl = $('#syncStatus');
    const urlInput = $('#webappUrl');

    // Guarda a URL do Web App em localStorage para n√£o precisar editar o c√≥digo
    const URL_KEY = 'preventivas_webapp_url';
    let WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxIQFUF8ZiPS9hppQXslliBbrH9F0GzpLxp9xi0vDQM29BRXuV9xqy3cOO7p1v_VX-b/exec";
    if (WEB_APP_URL) urlInput.value = WEB_APP_URL;

    $('#btnSalvarUrl').addEventListener('click', () => {
      WEB_APP_URL = urlInput.value.trim();
      localStorage.setItem(URL_KEY, WEB_APP_URL);
      flashStatus('URL salva.');
    });

    $('#btnSync').addEventListener('click', () => syncNow(true));

    function flashStatus(msg) {
      statusEl.textContent = msg + ' (' + new Date().toLocaleTimeString() + ')';
    }

    function salvarLocal(id, valor) {
      localStorage.setItem(id, valor);
    }

    function restaurarLocalParaElemento(el) {
      const id = el.dataset.id;
      const val = localStorage.getItem(id);
      if (val == null) return;
      if (el.type === 'checkbox') {
        el.checked = (val === 'true');
      } else {
        el.value = val;
      }
    }

    // =========================
    // GERA√á√ÉO DA UI
    function getNome(grupo, idx) {
      const arr = NOMES[grupo] || [];
      return arr[idx-1] || `Preventiva ${idx}`;
    }

    function gerarGrupo(num) {
      const wrapper = document.createElement('div');
      wrapper.className = 'grupo';
      wrapper.setAttribute('data-grupo', String(num));

      const header = document.createElement('div');
      header.className = 'grupo-header';
      header.innerHTML = `<span>Grupo ${num}</span><small>Clique para expandir</small>`;

      const conteudo = document.createElement('div');
      conteudo.className = 'grupo-conteudo';

      const form = document.createElement('form');

      for (let i = 1; i <= 11; i++) {
        const linha = document.createElement('div');
        linha.className = 'preventiva';

        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.dataset.id = `g${num}p${i}`; // feito

        const nome = document.createElement('div');
        nome.className = 'nome';
        nome.textContent = getNome(num, i); // NOME PR√â-DEFINIDO AQUI üß∑

        const desc = document.createElement('input');
        desc.type = 'text';
        desc.placeholder = `Descri√ß√£o da preventiva ${i}`;
        desc.dataset.id = `g${num}d${i}`; // descri√ß√£o

        linha.appendChild(chk);
        linha.appendChild(nome);
        linha.appendChild(desc);
        form.appendChild(linha);
      }

      // Notas do pr√≥ximo m√™s
      const notasWrap = document.createElement('div');
      notasWrap.className = 'area-notas';
      const notasLabel = document.createElement('label');
      notasLabel.textContent = 'O que precisa para o pr√≥ximo m√™s:';
      const notas = document.createElement('textarea');
      notas.dataset.id = `g${num}-notas`;

      notasWrap.appendChild(notasLabel);
      notasWrap.appendChild(notas);

      conteudo.appendChild(form);
      conteudo.appendChild(notasWrap);
      wrapper.appendChild(header);
      wrapper.appendChild(conteudo);

      return wrapper;
    }

    function gerarTudo() {
      const container = document.getElementById('grupos');
      container.innerHTML = '';
      for (let g = 1; g <= 6; g++) container.appendChild(gerarGrupo(g));
    }

    // =========================
    // ABRIR/FECHAR GRUPOS (delega√ß√£o)
    document.addEventListener('click', (e) => {
      const hdr = e.target.closest('.grupo-header');
      if (!hdr) return;
      const conteudo = hdr.nextElementSibling;
      conteudo.style.display = (conteudo.style.display === 'block') ? 'none' : 'block';
    });

    // =========================
    // SINCRONIZA√á√ÉO REMOTA (Google Apps Script)
    let pendentes = {}; // { id: valor }
    let syncTimer = null;

    function enfileirar(id, valor) {
      pendentes[id] = valor;
      if (syncTimer) clearTimeout(syncTimer);
      syncTimer = setTimeout(() => syncNow(false), 800); // debounce
    }

    async function carregarRemoto() {
      if (!WEB_APP_URL) return;
      try {
        flashStatus('Baixando dados remotos...');
        const resp = await fetch(WEB_APP_URL, { mode: 'cors', cache: 'no-store' });
        if (!resp.ok) throw new Error('Falha no GET');
        const dados = await resp.json(); // { id: valor }
        // aplica no DOM
        for (const [id, valor] of Object.entries(dados)) {
          const el = document.querySelector(`[data-id="${CSS.escape(id)}"]`);
          if (!el) continue;
          if (el.type === 'checkbox') el.checked = (valor === true || valor === 'true');
          else el.value = valor;
          // salva local para manter cache offline
          salvarLocal(id, (el.type === 'checkbox') ? String(el.checked) : el.value);
        }
        flashStatus('Dados remotos aplicados');
      } catch (err) {
        flashStatus('N√£o foi poss√≠vel carregar do remoto (ok usar offline)');
        console.warn(err);
      }
    }

    async function syncNow(forcado=false) {
      if (!WEB_APP_URL) { if (forcado) flashStatus('Defina a URL do Web App primeiro.'); return; }
      const payload = { ...pendentes };
      if (!Object.keys(payload).length && !forcado) return; // nada a enviar
      try {
        flashStatus('Sincronizando...');
        const resp = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // evita preflight CORS
          body: JSON.stringify(payload),
          mode: 'cors',
          cache: 'no-store'
        });
        if (!resp.ok) throw new Error('Falha no POST');
        pendentes = {}; // limpou fila
        flashStatus('Sincronizado');
      } catch (err) {
        flashStatus('Falha ao sincronizar (ser√° tentado depois)');
        console.warn(err);
      }
    }

    // =========================
    // INICIALIZA√á√ÉO
    document.addEventListener('DOMContentLoaded', () => {
      gerarTudo();

      // Restaura localStorage para todos os campos criados
      $$('input[type="checkbox"], input[type="text"], textarea').forEach(el => restaurarLocalParaElemento(el));

      // Listeners para salvar local + enfileirar sync
      $$('input[type="checkbox"]').forEach(chk => {
        chk.addEventListener('change', () => {
          salvarLocal(chk.dataset.id, String(chk.checked));
          enfileirar(chk.dataset.id, chk.checked);
        });
      });
      $$('input[type="text"]').forEach(inp => {
        inp.addEventListener('input', () => {
          salvarLocal(inp.dataset.id, inp.value);
          enfileirar(inp.dataset.id, inp.value);
        });
      });
      $$('textarea').forEach(area => {
        area.addEventListener('input', () => {
          salvarLocal(area.dataset.id, area.value);
          enfileirar(area.dataset.id, area.value);
        });
      });

      // Tenta carregar do remoto por √∫ltimo, para sobrepor com o que estiver na planilha
      carregarRemoto();
    });
  </script>
</body>
</html>
